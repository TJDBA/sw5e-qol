<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StateManager Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>SW5E QoL - StateManager Test</h1>
    
    <div class="test-section">
        <h2>StateManager Functionality Tests</h2>
        <p>Click the buttons below to test different StateManager features:</p>
        
        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        <button class="test-button" onclick="clearOutput()">Clear Output</button>
        <button class="test-button" onclick="testPackFeatures()">Test Pack Features</button>
        <button class="test-button" onclick="testSerialization()">Test Serialization</button>
    </div>
    
    <div class="test-section">
        <h3>Test Output</h3>
        <div id="output" class="output">Click a test button to see results...</div>
    </div>
    
    <div class="test-section">
        <h3>State Object Inspector</h3>
        <div id="stateInspector" class="output">No state object loaded...</div>
    </div>

    <script type="module">
        // Mock Foundry objects for testing
        globalThis.game = {
            actors: {
                get: (id) => ({ id, name: `Actor ${id}`, type: 'character', img: '' })
            },
            scenes: {
                get: (id) => ({
                    tokens: {
                        get: (tokenId) => ({ id: tokenId, name: `Token ${tokenId}`, document: { img: '' } })
                    }
                })
            }
        };

        // Mock Roll class
        globalThis.Roll = class MockRoll {
            constructor(formula) {
                this.formula = formula;
                this.total = Math.floor(Math.random() * 20) + 1;
                this.results = [{ result: this.total }];
            }
        };

        // Mock Token class
        globalThis.Token = class MockToken {
            constructor(data) {
                Object.assign(this, data);
            }
        };

        // Mock Actor class
        globalThis.Actor = class MockActor {
            constructor(data) {
                Object.assign(this, data);
            }
        };

        // Mock Item class
        globalThis.Item = class MockItem {
            constructor(data) {
                Object.assign(this, data);
            }
        };

        // Import StateManager
        import { StateManager } from './scripts/core/state/state-manager.js';

        // Make StateManager globally available
        globalThis.StateManager = StateManager;

        // Test functions
        globalThis.runAllTests = async function() {
            clearOutput();
            log('Running all StateManager tests...\n', 'success');
            
            try {
                await testBasicFunctionality();
                await testPackFeatures();
                await testSerialization();
                log('\nAll tests completed successfully!', 'success');
            } catch (error) {
                log(`\nTest failed with error: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };

        globalThis.testPackFeatures = async function() {
            clearOutput();
            log('Testing Pack Features...\n', 'success');
            await testPackFeatures();
        };

        globalThis.testSerialization = async function() {
            clearOutput();
            log('Testing Serialization...\n', 'success');
            await testSerialization();
        };

        globalThis.clearOutput = function() {
            document.getElementById('output').textContent = '';
            document.getElementById('stateInspector').textContent = 'No state object loaded...';
        };

        // Helper functions
        function log(message, type = '') {
            const output = document.getElementById('output');
            const className = type ? type : '';
            const span = document.createElement('span');
            span.className = className;
            span.textContent = message;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function updateStateInspector(state) {
            const inspector = document.getElementById('stateInspector');
            inspector.textContent = JSON.stringify(state, null, 2);
        }

        // Test functions
        async function testBasicFunctionality() {
            log('--- Test 1: Basic Functionality ---\n');
            
            const stateManager = new StateManager();
            log('✓ StateManager created successfully\n');
            
            // Test creating workflow state
            const attackState = stateManager.createWorkflowState('attack', {
                actor: { id: 'actor1', name: 'Test Actor' },
                targets: [{ id: 'target1', name: 'Test Target' }]
            });
            log('✓ Attack state created\n');
            log(`  - Workflow Type: ${attackState.workflowType}\n`);
            log(`  - Actor: ${attackState.actor.name}\n`);
            log(`  - Targets: ${attackState.targets.length}\n`);
            
            updateStateInspector(attackState);
            return attackState;
        }

        async function testPackFeatures() {
            log('--- Test 2: Pack Features ---\n');
            
            const stateManager = new StateManager();
            let state = stateManager.createWorkflowState('attack');
            
            // Add pack features
            state = stateManager.addPackFeature(state, 'combat-superiority', {
                superiorityDice: '1d8',
                used: false
            });
            log('✓ Added combat-superiority feature\n');
            
            state = stateManager.addPackFeature(state, 'force-empowered-strikes', {
                damageConversion: { from: 'kinetic', to: 'energy' }
            });
            log('✓ Added force-empowered-strikes feature\n');
            
            // Test feature operations
            log(`✓ Has combat-superiority: ${stateManager.hasPackFeature(state, 'combat-superiority')}\n`);
            log(`✓ Has force-empowered-strikes: ${stateManager.hasPackFeature(state, 'force-empowered-strikes')}\n`);
            
            const feature = stateManager.getPackFeature(state, 'combat-superiority');
            log(`✓ Combat superiority data: ${JSON.stringify(feature)}\n`);
            
            // Remove a feature
            state = stateManager.removePackFeature(state, 'combat-superiority');
            log(`✓ Removed combat-superiority: ${!stateManager.hasPackFeature(state, 'combat-superiority')}\n`);
            
            updateStateInspector(state);
            return state;
        }

        async function testSerialization() {
            log('--- Test 3: Serialization ---\n');
            
            const stateManager = new StateManager();
            
            // Create state with complex data
            const state = stateManager.createWorkflowState('attack', {
                actor: new Actor({ id: 'actor1', name: 'Test Actor', type: 'character', img: 'test.jpg' }),
                targets: [new Token({ id: 'token1', name: 'Test Token', document: { img: 'token.jpg' } })],
                data: {
                    weapon: new Item({ id: 'weapon1', name: 'Lightsaber', type: 'weapon', img: 'weapon.jpg' }),
                    attackRoll: new Roll('1d20+5')
                }
            });
            
            log('✓ Created state with complex objects\n');
            
            // Serialize
            const serialized = stateManager.serializeState(state);
            log('✓ State serialized successfully\n');
            log(`  - Serialized size: ${JSON.stringify(serialized).length} characters\n`);
            
            // Deserialize
            const deserialized = stateManager.deserializeState(serialized);
            log('✓ State deserialized successfully\n');
            
            // Verify key data is preserved
            const originalActor = state.actor;
            const deserializedActor = deserialized.actor;
            
            log(`  - Actor ID preserved: ${originalActor.id === deserializedActor.id}\n`);
            log(`  - Actor name preserved: ${originalActor.name === deserializedActor.name}\n`);
            log(`  - Roll formula preserved: ${state.data.attackRoll.formula === deserialized.data.attackRoll.formula}\n`);
            
            updateStateInspector(deserialized);
            return { original: state, serialized, deserialized };
        }
    </script>
</body>
</html>
